name: Post-Deploy Smoke Tests

on:
  deployment_status:

jobs:
  smoke-test:
    name: Run Smoke Tests
    # Only run on successful production deployments
    if: github.event.deployment_status.state == 'success' && github.event.deployment_status.environment == 'production'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run smoke tests against production
        run: npm run test:live

      - name: Upload test report on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-report
          path: playwright-report/
          retention-days: 90

      - name: Create issue on smoke test failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // Get deployment details
            const commit = context.payload.deployment.sha.substring(0, 7);
            const fullCommit = context.payload.deployment.sha;
            const deployer = context.payload.deployment.creator?.login || 'unknown';
            const timestamp = context.payload.deployment_status.updated_at;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // Check for existing issue with this commit SHA to prevent duplicates
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'escape',
              per_page: 100
            });

            const duplicateIssue = existingIssues.data.find(issue =>
              issue.title.includes('[SMOKE TEST FAILURE]') &&
              issue.body.includes(fullCommit)
            );

            if (duplicateIssue) {
              // Add comment to existing issue instead of creating duplicate
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: duplicateIssue.number,
                body: `## Additional Smoke Test Failure\n\n**Timestamp:** ${timestamp}\n**Workflow Run:** ${runUrl}\n\nSmoke tests failed again for this deployment. Check the latest test artifacts for updated failure details.`
              });
              console.log(`Added comment to existing issue #${duplicateIssue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[SMOKE TEST FAILURE] Deployment ${commit} by ${deployer}`,
                labels: ['type:bug', 'severity:high', 'escape'],
                body: `## Deployment Info

            - **Commit:** ${fullCommit}
            - **Deployer:** ${deployer}
            - **Timestamp:** ${timestamp}
            - **Branch:** ${context.payload.deployment.ref}

            ## Test Failure Summary

            **Production smoke tests failed post-deployment.**

            The automated smoke tests detected failures after deploying to production. This indicates a potential production issue that was not caught by pre-deploy testing.

            ## Links

            - **Workflow Run:** ${runUrl}
            - **Test Artifacts:** Check the workflow run above for test reports

            ## Production Impact

            ‚ö†Ô∏è Smoke tests failed post-deployment. Production may be affected.

            ## Next Steps

            - [ ] **Assessed and routed** (PM triage)
            - Review test failure details in the workflow run
            - Investigate root cause
            - Determine if this is a new defect, existing known issue, or flaky test
            - Create bugfix spec if needed
            - Deploy fix and verify

            ## Escape Assessment

            This issue has been auto-labeled as an \`escape\` because it represents a production issue not caught by pre-deploy tests. PM should assess:

            - **Did this issue pass through our pipeline?** If yes, which gate should have caught it?
            - **Should an escape event be created?** (Use template: learning/escapes/escape_event_template.md)
            - **What prevention measure is needed?** (Test coverage, checklist item, etc.)

            ---

            ü§ñ Auto-created by smoke test failure workflow (SPEC-008)`
              });
              console.log(`Created issue #${issue.data.number}`);
            }

      - name: Notify Slack on failure
        id: slack-notification
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "Production Smoke Tests Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üö® Production Smoke Tests Failed*\n*Environment:* production\n*Commit:* `${{ github.sha }}`\n*Deployer:* ${{ github.actor }}\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/attempts/${{ github.run_attempt }}#artifacts|View Test Artifacts>"
                  }
                }
              ]
            }
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Add workflow summary
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "## ‚úÖ Production Smoke Tests Passed" >> $GITHUB_STEP_SUMMARY
            echo "All smoke tests passed successfully against https://geekbyte.biz" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Production Smoke Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "Smoke tests failed against https://geekbyte.biz" >> $GITHUB_STEP_SUMMARY
            echo "Check the test report artifact for details." >> $GITHUB_STEP_SUMMARY
          fi
