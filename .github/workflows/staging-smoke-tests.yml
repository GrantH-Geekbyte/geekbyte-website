name: Staging Smoke Tests

on:
  deployment_status:

jobs:
  staging-smoke-test:
    name: Run Staging Smoke Tests
    # Only run on successful staging deployments (not production)
    # Vercel staging deployments have environment 'Preview' or branch that isn't production
    if: |
      github.event.deployment_status.state == 'success' &&
      github.event.deployment_status.environment != 'Production'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run smoke tests against staging
        env:
          STAGING_URL: ${{ github.event.deployment_status.target_url }}
        run: |
          echo "Testing staging deployment at: $STAGING_URL"
          npx playwright test tests/e2e/pages.spec.js tests/e2e/navigation.spec.js \
            --project=chromium \
            --base-url=$STAGING_URL

      - name: Upload test report on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: staging-smoke-test-report
          path: playwright-report/
          retention-days: 30

      - name: Create comment on PR if tests fail
        if: failure() && github.event.pull_request
        uses: actions/github-script@v7
        with:
          script: |
            const stagingUrl = process.env.STAGING_URL || 'Unknown';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ⚠️ Staging Smoke Tests Failed\n\n**Staging URL:** ${stagingUrl}\n**Workflow Run:** ${runUrl}\n\nThe staging deployment smoke tests detected failures. Please review the test artifacts before promoting to production.\n\n**Note:** This does not block the deployment. Manual review is still required before production promotion.`
            });

      - name: Notify Slack on failure
        id: slack-notification
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "Staging Smoke Tests Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*⚠️ Staging Smoke Tests Failed*\n*Environment:* Staging/Preview\n*Deployment URL:* ${{ github.event.deployment_status.target_url }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* `${{ github.sha }}`\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/attempts/${{ github.run_attempt }}#artifacts|View Test Artifacts>"
                  }
                }
              ]
            }
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Add workflow summary
        if: always()
        env:
          STAGING_URL: ${{ github.event.deployment_status.target_url }}
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "## ✅ Staging Smoke Tests Passed" >> $GITHUB_STEP_SUMMARY
            echo "All smoke tests passed successfully against staging deployment" >> $GITHUB_STEP_SUMMARY
            echo "**Staging URL:** $STAGING_URL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Manually review the staging site at the URL above" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify cross-browser compatibility if needed" >> $GITHUB_STEP_SUMMARY
            echo "3. When ready, promote to production via Vercel console or GitHub release" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ Staging Smoke Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "Smoke tests failed against staging deployment" >> $GITHUB_STEP_SUMMARY
            echo "**Staging URL:** $STAGING_URL" >> $GITHUB_STEP_SUMMARY
            echo "Check the test report artifact for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**⚠️ Note:** This failure does NOT block the deployment." >> $GITHUB_STEP_SUMMARY
            echo "Manual PM review is still required before production promotion." >> $GITHUB_STEP_SUMMARY
          fi
